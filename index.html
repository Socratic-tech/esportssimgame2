<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Esports Company Management Simulation v2.3</title>
  <style>
    :root{
      --bg:#070b16;
      --panel:#11172b;
      --line:#1f2a52;
      --text:#e8eeff;
      --muted:#b9c8ff;
      --accent:#6aa8ff;
      --good:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(circle at top,#192247 0,#070b16 55%);
      color:var(--text);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      line-height:1.55;
    }
    header{
      background:#050815d9;
      border-bottom:1px solid var(--line);
      backdrop-filter:blur(10px);
      position:sticky;
      top:0;
      z-index:10;
    }
    header .wrap{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      max-width:1100px;
      margin:0 auto;
    }
    h1{
      font-size:20px;
      color:var(--accent);
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .wrap-main{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type=text]{
      background:#050816;
      border:1px solid #2a3a6e;
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      min-width:220px;
      font-size:14px;
    }
    .btn{
      background:#1a3d86;
      border:1px solid #2453a5;
      color:#fff;
      padding:8px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{filter:brightness(1.07)}
    .btn.good{background:#166534;border-color:#16a34a;}
    .btn.bad{background:#7f1d1d;border-color:#b91c1c;}
    .btn.ghost{background:transparent;border-color:var(--line);color:var(--muted);}
    .btn.small{padding:6px 10px;font-size:12px;}
    .grid{display:grid;gap:12px;}
    .card{
      background:rgba(9,13,32,0.92);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 18px 45px rgba(0,0,0,0.5);
    }
    .status{
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    }
    .kpi h3{
      margin:0 0 4px 0;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .kpi .v{
      font-weight:700;
      font-size:18px;
    }
    .kpi .sub{
      font-size:11px;
      color:#9ca6ff;
    }
    .event{
      background:#05091b;
      border-radius:12px;
      padding:12px;
      border:1px solid #232f61;
      margin-top:8px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      background:#050816;
      color:var(--muted);
    }
    .meter{
      height:10px;
      background:#050816;
      border-radius:999px;
      border:1px solid #202856;
      overflow:hidden;
    }
    .meter > i{
      display:block;
      height:100%;
      background:linear-gradient(90deg,#ef4444,#f59e0b,#10b981);
      transition:width .25s ease-out;
    }
    .choices{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:12px;
      margin-top:12px;
    }
    fieldset{
      border:1px dashed var(--line);
      border-radius:14px;
      padding:10px 10px 6px;
    }
    legend{
      padding:0 6px;
      color:var(--muted);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .option{
      display:flex;
      gap:8px;
      align-items:flex-start;
      padding:7px 6px;
      border-radius:10px;
      border:1px solid transparent;
      cursor:pointer;
      margin-bottom:2px;
    }
    .option:hover{border-color:#28408e;background:rgba(24,38,94,0.4);}
    .option input{margin-top:3px;}
    .opt-main{font-size:13px;font-weight:600;}
    .helper{font-size:11px;color:#cbd5ff;}
    .actions{display:flex;gap:8px;flex-wrap:wrap;}
    .log{
      background:#050816;
      border-radius:12px;
      border:1px dashed var(--line);
      padding:10px;
      font-size:12px;
      max-height:260px;
      overflow:auto;
      white-space:pre-wrap;
    }
    .muted{color:#cbd5ff;font-size:13px;}
    .footerbar{
      position:sticky;
      bottom:0;
      background:#050815f0;
      border-top:1px solid var(--line);
      backdrop-filter:blur(10px);
      padding:8px 0;
      margin-top:16px;
    }
    .footer-wrap{
      max-width:1100px;
      margin:0 auto;
      padding:0 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge-mode{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
    }
    .badge-mode.standard{color:var(--warn);}
    .badge-mode.extended{color:var(--good);}
    #finalScreen{margin-top:16px;}
    #standardPrompt{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.65);
      backdrop-filter:blur(4px);
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    #standardPrompt .modal{
      background:#050816;
      border-radius:16px;
      border:1px solid var(--line);
      padding:18px;
      max-width:420px;
      width:90%;
    }
    @keyframes fall{to{transform:translateY(100vh) rotate(720deg);opacity:.1}}
    @media (max-width:640px){.choices{grid-template-columns:1fr}}
    @media print{
      header,.footerbar,#intro .actions,#game .actions,#standardPrompt{display:none !important}
      body{background:#fff;color:#000;}
      .card,.log{background:#fff;border-color:#000;box-shadow:none;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üéÆ Esports Org Manager <span style="font-size:11px;font-weight:400;color:#9ca6ff;">Esports 100 ‚Ä¢ Lake Michigan College</span></h1>
      <div class="row">
        <label class="muted" for="studentName" style="font-size:12px;">Student Name</label>
        <input id="studentName" type="text" placeholder="Enter your name" />
        <button class="btn ghost small" id="btnReset">Reset</button>
      </div>
    </div>
  </header>

  <main class="wrap-main">
    <!-- Intro / Instructions -->
    <section id="intro" class="card">
      <h2 style="margin-top:0;">Welcome, Manager X</h2>
      <p class="muted">
        You are the founder of a brand-new esports organization. You have just qualified into <b>Tier 3 (Rookie)</b>
        and secured <b>$250,000</b> to launch your team. Your job is to make strategic choices about
        <b>space</b>, <b>equipment</b>, <b>players</b>, and ongoing <b>operations</b>.
      </p>
      <p class="muted">
        The simulation runs in turns and is designed for about <b>30 minutes</b> of Standard Play.
        At that point you can end and score, or continue in <b>Extended Mode</b> until you either
        <b>retire</b> or achieve <b>Mastery</b>.
      </p>
      <details class="card" style="margin-top:8px;background:#050816;">
        <summary><b>What is TSR (Team Skill Rating)?</b></summary>
        <p class="muted" style="margin-top:6px;">
          <b>Team Skill Rating (TSR)</b> is a 0‚Äì100 estimate of your competitive strength.
          Higher TSR plus healthy morale increases your <b>win probability</b>, which drives prize money,
          fan growth, and sponsor interest.
        </p>
      </details>
      <ul class="muted" style="font-size:12px;margin-top:10px;">
        <li><b>Startup Phase (1 turn):</b> choose your facility, equipment, and players.</li>
        <li><b>Season Phase:</b> each turn, 3 random cards are drawn from a deck of ~30 options in each category.</li>
        <li><b>Win/Loss Logic:</b> wins bring prize money and fans; losses hurt sponsors and fans.</li>
        <li><b>Game Over:</b> two turns in a row with negative cash (Financial Ruin) or morale reaching zero (Mutiny).</li>
      </ul>
      <div class="actions" style="margin-top:10px;">
        <button class="btn" id="btnStart">Start Simulation</button>
      </div>
    </section>

    <!-- Main Game -->
    <section id="game" style="display:none;">
      <div class="grid status">
        <div class="card kpi">
          <h3>Turn</h3>
          <div class="v" id="kTurn"></div>
          <div class="sub" id="kPhase"></div>
        </div>
        <div class="card kpi">
          <h3>Season</h3>
          <div class="v" id="kSeason"></div>
          <div class="sub" id="kMode"></div>
        </div>
        <div class="card kpi">
          <h3>Cash Reserves</h3>
          <div class="v" id="kCash"></div>
          <div class="sub">Goal: stay ‚â• 0</div>
        </div>
        <div class="card kpi">
          <h3>Fixed Expenses</h3>
          <div class="v" id="kFixed"></div>
          <div class="sub">per turn</div>
        </div>
        <div class="card kpi">
          <h3>Fan Base</h3>
          <div class="v" id="kFans"></div>
        </div>
        <div class="card kpi">
          <h3>TSR</h3>
          <div class="v" id="kTSR"></div>
        </div>
        <div class="card kpi">
          <h3>Morale</h3>
          <div class="v" id="kMorale"></div>
        </div>
        <div class="card kpi">
          <h3>Rank</h3>
          <div class="v" id="kRank"></div>
        </div>
        <div class="card kpi">
          <h3>Debt</h3>
          <div class="v" id="kDebt"></div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="row" style="align-items:center;">
          <span class="pill">Win Probability</span>
          <div class="meter" style="flex:1;min-width:180px;margin:0 6px;">
            <i id="winBar" style="width:40%;"></i>
          </div>
          <span class="muted" id="winPct">40%</span>
          <span class="pill" style="margin-left:auto;">Session Progress
            <span id="turnProgressPct" style="margin-left:6px;">0%</span>
          </span>
        </div>
      </div>

      <div id="scenarioBox" class="event"></div>

      <div class="choices">
        <fieldset id="col1"></fieldset>
        <fieldset id="col2"></fieldset>
        <fieldset id="col3"></fieldset>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="btn" id="btnRun" disabled>Confirm Decisions & Run Turn</button>
        <button class="btn ghost" id="btnRandom" title="Quick pick one option per column">Quick Pick</button>
        <button class="btn ghost" id="btnUndo" disabled>Undo Last Turn</button>
        <button class="btn ghost" id="btnEndEarly">End & Score Now</button>
      </div>

      <div class="grid" style="grid-template-columns:1.1fr .9fr;gap:12px;margin-top:12px;">
        <div class="card">
          <h3 style="margin-top:0;font-size:14px;">Finance Summary (this turn)</h3>
          <div id="finance" class="muted"></div>
          <p class="muted" id="feedback" style="margin-top:8px;font-style:italic;"></p>
        </div>
        <div class="log" id="log"></div>
      </div>
    </section>

    <!-- Final Scoring -->
    <section id="finalScreen" class="card" style="display:none;">
    <section id="finalScreen" class="card" style="display:none;">
  <h2 style="margin-top:0;">Final Scoring Screen</h2>
  <pre id="finalText" class="muted" style="white-space:pre-wrap;"></pre>

  <!-- Visual analytics panel -->
  <div id="analyticsPanel" style="margin-top:12px;">
    <h3 style="margin:0 0 6px 0;">Visual Breakdown</h3>

    <div class="grid" style="grid-template-columns:1.2fr 1fr;gap:12px;">
      <div class="card">
        <h4 style="margin-top:0;">Cash Flow Over Time vs Average</h4>
        <canvas id="cashChart" height="140"></canvas>
      </div>
      <div class="card">
        <h4 style="margin-top:0;">TSR Progression vs Average</h4>
        <canvas id="tsrChart" height="140"></canvas>
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1.2fr 1fr;gap:12px;margin-top:12px;">
      <div class="card">
        <h4 style="margin-top:0;">Key Decision Moments</h4>
        <ul id="keyMomentsList" class="muted" style="font-size:12px;padding-left:18px;margin:6px 0;"></ul>
      </div>
      <div class="card">
        <h4 style="margin-top:0;">‚ÄúWhat if?‚Äù Scenarios</h4>
        <ul id="whatIfList" class="muted" style="font-size:12px;padding-left:18px;margin:6px 0;"></ul>
      </div>
    </div>
  </div>

  <div class="actions" style="margin-top:10px;">
    <button class="btn good" id="btnPDF">Save Final Report (PDF)</button>
    <button class="btn" id="btnContinueExtended">Continue in Extended Mode</button>
  </div>
</section>


    <!-- Standard Session Prompt -->
    <div id="standardPrompt">
      <div class="modal">
        <h3 style="margin-top:0;">Standard Session Complete</h3>
        <p class="muted">
          You have reached the end of the <b>Standard Play</b> window (designed for about 30 minutes).
          You can end now and receive your Final Score, or switch into <b>Extended Mode</b> and keep managing your org.
        </p>
        <div class="actions" style="margin-top:10px;">
          <button class="btn good" id="btnEndStandard">End Now & Score</button>
          <button class="btn" id="btnGoExtended">Continue in Extended Mode</button>
          <button class="btn ghost" id="btnCancelPrompt">Cancel</button>
        </div>
      </div>
    </div>

  </main>

  <div class="footerbar">
    <div class="footer-wrap">
      <span class="muted">
        Make one choice per column each turn. Wins earn prize money and fans; losses apply a sponsor penalty and fan drop.
      </span>
      <div class="row">
        <span id="modeBadge" class="badge-mode standard">Standard Mode</span>
        <button class="btn ghost small" id="btnPrint">Print Page</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // DOM refs
    const elIntro = $('#intro');
    const elGame = $('#game');
    const elFinal = $('#finalScreen');
    const elName = $('#studentName');
    const elReset = $('#btnReset');
    const elStart = $('#btnStart');
    const elRun = $('#btnRun');
    const elRandom = $('#btnRandom');
    const elUndo = $('#btnUndo');
    const elEndEarly = $('#btnEndEarly');
    const elPrint = $('#btnPrint');
    const elFinance = $('#finance');
    const elFeedback = $('#feedback');
    const elScenario = $('#scenarioBox');
    const elLog = $('#log');
    const elFinalText = $('#finalText');
    const elPDF = $('#btnPDF');
    const elContinueExtended = $('#btnContinueExtended');
    const winBar = $('#winBar');
    const winPct = $('#winPct');
    const turnProgressPct = $('#turnProgressPct');
    const modeBadge = $('#modeBadge');
    const promptWrap = $('#standardPrompt');
    const btnEndStandard = $('#btnEndStandard');
    const btnGoExtended = $('#btnGoExtended');
    const btnCancelPrompt = $('#btnCancelPrompt');
     
    // Analytics DOM
    const cashChartCanvas = $('#cashChart');
    const tsrChartCanvas = $('#tsrChart');
    const keyMomentsList = $('#keyMomentsList');
    const whatIfList = $('#whatIfList');

    // Chart instances
    let cashChartInstance = null;
    let tsrChartInstance = null;

    const kTurn = $('#kTurn');
    const kPhase = $('#kPhase');
    const kSeason = $('#kSeason');
    const kMode = $('#kMode');
    const kCash = $('#kCash');
    const kFixed = $('#kFixed');
    const kFans = $('#kFans');
    const kTSR = $('#kTSR');
    const kMorale = $('#kMorale');
    const kRank = $('#kRank');
    const kDebt = $('#kDebt');

    const col1 = $('#col1');
    const col2 = $('#col2');
    const col3 = $('#col3');

    const fmtMoney = n => '$' + Number(n || 0).toLocaleString();
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const rankName = r => r === 1 ? 'Tier 1 (Elite)' : r === 2 ? 'Tier 2 (Challenger)' : 'Tier 3 (Rookie)';

    const save = () => {
      try { localStorage.setItem('mgrx_v2_autosave', JSON.stringify(S)); } catch {}
    };
    const load = () => {
      try { return JSON.parse(localStorage.getItem('mgrx_v2_autosave') || 'null'); } catch { return null; }
    };

    const START = {
      turn: 1,
      season: 1,
      phase: 'startup',     // 'startup' | 'season' | 'ended'
      mode: 'standard',     // 'standard' | 'extended'
      maxStandardTurns: 10, // includes startup turn
      turnsTotal: 9999,
      cash: 250000,
      salaries: 30000,
      fans: 5000,
      tsr: 60,
      morale: 70,
      rank: 3,
      debt: 0,
      facilityLevel: 0,
      facilityCondition: 100,
      equipmentLevel: 0,
      brandReputation: 1.0,
      sponsorshipTier: 1,
      merchNext: 0,
      streak: 0,
      negCashStreak: 0,
      problemCooldown: 0,
      name: '',
      history: [],
      undoStack: [],
      mastered: false,
      endedReason: null
    };

    let S = load() || { ...START };

    // ---------- STARTUP CONFIG ----------
    const STARTUP_CONFIG = {
      columns: [
        {
          legend: '1) Facilities',
          group: 'g1',
          options: [
            {
              id: 'fac_shared',
              title: 'Shared Office Space',
              desc: 'Low rent, modest setup. Fixed +$5K/turn, morale +3.'
            },
            {
              id: 'fac_leased',
              title: 'Leased Esports Facility',
              desc: 'Higher rent but strong practice. Fixed +$10K/turn, TSR and morale up.'
            },
            {
              id: 'fac_house',
              title: 'Custom Gaming House',
              desc: 'Expensive but premium. Fixed +$18K/turn, big morale and TSR potential.'
            }
          ]
        },
        {
          legend: '2) Equipment Setup',
          group: 'g2',
          options: [
            {
              id: 'eq_basic',
              title: 'Basic Gaming PCs',
              desc: 'Budget rigs. Low cost, limited performance.'
            },
            {
              id: 'eq_pro',
              title: 'Pro-Level Setup',
              desc: 'Stronger PCs. TSR +5, brand rep up slightly.'
            },
            {
              id: 'eq_premium',
              title: 'Premium Streaming Rig',
              desc: 'Top gear and content-ready. TSR +5, fans from streaming.'
            }
          ]
        },
        {
          legend: '3) Player Recruitment',
          group: 'g3',
          options: [
            {
              id: 'ros_local',
              title: 'Local Rookies',
              desc: 'Cheap contracts, low TSR, high morale potential.'
            },
            {
              id: 'ros_mix',
              title: 'Semi-Pro Mix',
              desc: 'Balanced costs. TSR +5, morale moderate, fans modest.'
            },
            {
              id: 'ros_stars',
              title: 'Star Free Agents',
              desc: 'High salaries. TSR +10, +2K fans, morale fragile.'
            }
          ]
        }
      ]
    };

    // ---------- SEASON DECKS (30 cards per category) ----------
    const SEASON_DECKS = {
      ops: [
        { id:'ops_analyst',          title:'Hire Analyst ($20K)',                    desc:'Var ‚àí$20K, fixed +$5K/turn, TSR +5.',              varCost:20000, fixedDelta:5000, tsr:+5 },
        { id:'ops_assistant',        title:'Hire Team Manager ($15K)',              desc:'Var ‚àí$15K, fixed +$4K/turn, morale +4.',          varCost:15000, fixedDelta:4000, morale:+4 },
        { id:'ops_data',             title:'Invest in Data Tools ($10K)',           desc:'Var ‚àí$10K, TSR +3, brand rep +0.03.',            varCost:10000, tsr:+3, brandDelta:+0.03 },
        { id:'ops_gym',              title:'Add Gym Memberships ($8K)',             desc:'Var ‚àí$8K, morale +5.',                            varCost:8000,  morale:+5 },
        { id:'ops_diet',             title:'Sports Nutrition Program ($12K)',       desc:'Var ‚àí$12K, TSR +2, morale +2.',                   varCost:12000, tsr:+2, morale:+2 },
        { id:'ops_house_upgrade',    title:'Facility Deep Clean & Repair ($18K)',   desc:'Var ‚àí$18K, facility condition +10, morale +3.',  varCost:18000, facilityCond:+10, morale:+3 },
        { id:'ops_travel_upgrade',   title:'Upgrade Travel Comfort ($10K)',         desc:'Var ‚àí$10K, morale +3, TSR +1.',                   varCost:10000, morale:+3, tsr:+1 },
        { id:'ops_cut_staff',        title:'Cut Support Staff ($0)',                desc:'Fixed ‚àí$5K/turn, morale ‚àí5.',                     varCost:0,     fixedDelta:-5000, morale:-5 },
        { id:'ops_stream_room',      title:'Build Stream Studio ($25K)',            desc:'Var ‚àí$25K, fans +800, brand +0.05.',             varCost:25000, fans:+800, brandDelta:+0.05 },
        { id:'ops_sleep',            title:'Sleep & Wellness Program ($12K)',       desc:'Var ‚àí$12K, morale +6, TSR +1.',                  varCost:12000, morale:+6, tsr:+1 },
        { id:'ops_interns',          title:'Bring in Interns ($5K)',                desc:'Var ‚àí$5K, fixed +$1K, morale +1, fans +100.',    varCost:5000,  fixedDelta:1000, morale:+1, fans:+100 },
        { id:'ops_rent_negotiate',   title:'Negotiate Rent ($0)',                   desc:'Fixed ‚àí$3K/turn, brand rep ‚àí0.02.',              varCost:0,     fixedDelta:-3000, brandDelta:-0.02 },
        { id:'ops_hr_policy',        title:'Formal HR Policies ($6K)',              desc:'Var ‚àí$6K, morale +3 over time.',                  varCost:6000,  morale:+3 },
        { id:'ops_security',         title:'Upgrade Security ($9K)',                desc:'Var ‚àí$9K, protects equipment; small brand boost.',varCost:9000,  brandDelta:+0.02 },
        { id:'ops_it_upgrade',       title:'IT Infrastructure Upgrade ($14K)',      desc:'Var ‚àí$14K, fewer tech issues, TSR +2.',          varCost:14000, tsr:+2 },
        { id:'ops_backup_power',     title:'Backup Power System ($11K)',            desc:'Var ‚àí$11K, reduces chance of problem events.',    varCost:11000, facilityCond:+5 },
        { id:'ops_head_coach',       title:'Hire Head Coach ($22K)',                desc:'Var ‚àí$22K, fixed +$8K/turn, TSR +6.',            varCost:22000, fixedDelta:8000, tsr:+6 },
        { id:'ops_scrim_partner',    title:'Exclusive Scrim Partners ($13K)',       desc:'Var ‚àí$13K, TSR +4.',                             varCost:13000, tsr:+4 },
        { id:'ops_transport_contract',title:'Travel Contract ($0)',                 desc:'Fixed +$2K/turn, reduces variable travel risk.',  varCost:0,     fixedDelta:2000 },
        { id:'ops_cleaning_service', title:'Pro Cleaning Service ($7K)',            desc:'Var ‚àí$7K, facility condition +8, morale +2.',    varCost:7000,  facilityCond:+8, morale:+2 },
        { id:'ops_healthcare',       title:'Player Healthcare Plan ($15K)',         desc:'Var ‚àí$15K, morale +5.',                           varCost:15000, morale:+5 },
        { id:'ops_video_review_room',title:'Video Review Room ($16K)',              desc:'Var ‚àí$16K, TSR +4.',                             varCost:16000, tsr:+4 },
        { id:'ops_qa_team',          title:'Quality Assurance Staff ($10K)',        desc:'Var ‚àí$10K, brand +0.03.',                        varCost:10000, brandDelta:+0.03 },
        { id:'ops_insurance',        title:'Comprehensive Insurance ($9K)',         desc:'Var ‚àí$9K, protects vs big losses.',              varCost:9000 },
        { id:'ops_benchmark_trip',   title:'Benchmark Visit to Pro Org ($18K)',     desc:'Var ‚àí$18K, TSR +3, brand +0.03.',                varCost:18000, tsr:+3, brandDelta:+0.03 },
        { id:'ops_staff_retreat',    title:'Staff-Only Retreat ($12K)',             desc:'Var ‚àí$12K, morale +4.',                          varCost:12000, morale:+4 },
        { id:'ops_automation',       title:'Workflow Automation Software ($15K)',   desc:'Var ‚àí$15K, fixed ‚àí$3K/turn, morale +1.',         varCost:15000, fixedDelta:-3000, morale:+1 },
        { id:'ops_legal_consult',    title:'Legal Consultation ($8K)',              desc:'Var ‚àí$8K, protects brand in long run.',          varCost:8000 },
        { id:'ops_accounting',       title:'Hire Accounting Firm ($10K)',           desc:'Var ‚àí$10K, better cost control; small fixed cut.',varCost:10000, fixedDelta:-2000 },
        { id:'ops_green_initiative', title:'Green Facility Initiative ($9K)',       desc:'Var ‚àí$9K, brand +0.04, morale +1.',              varCost:9000,  brandDelta:+0.04, morale:+1 }
      ],
      mkt: [
        { id:'mkt_merch',            title:'Launch Merch ($25K)',                   desc:'Var ‚àí$25K, +1K fans, +$10K merch next turn.',       varCost:25000, fans:+1000, merchNext:10000 },
        { id:'mkt_local',            title:'Host Local Event ($30K)',               desc:'Var ‚àí$30K, +2K fans, morale +5.',                   varCost:30000, fans:+2000, morale:+5 },
        { id:'mkt_minimal',          title:'Minimal Social ($0)',                   desc:'No spend, no immediate change.',                    varCost:0 },
        { id:'mkt_stream',           title:'Weekly Stream Schedule ($8K)',          desc:'Var ‚àí$8K, fans +600, brand +0.04.',                 varCost:8000,  fans:+600, brandDelta:+0.04 },
        { id:'mkt_college',          title:'Campus Activation ($15K)',              desc:'Var ‚àí$15K, fans +1200, brand +0.03.',               varCost:15000, fans:+1200, brandDelta:+0.03 },
        { id:'mkt_collab',           title:'Collab with Influencer ($20K)',         desc:'Var ‚àí$20K, fans +1500, merch next +$5K.',           varCost:20000, fans:+1500, merchNext:5000 },
        { id:'mkt_docu',             title:'Mini-Doc Series ($18K)',                desc:'Var ‚àí$18K, fans +900, morale +3.',                  varCost:18000, fans:+900, morale:+3 },
        { id:'mkt_vip',              title:'VIP Fan Discord ($5K)',                 desc:'Var ‚àí$5K, fans +400, brand +0.02.',                 varCost:5000,  fans:+400, brandDelta:+0.02 },
        { id:'mkt_cheap_ads',        title:'Cheap Online Ads ($6K)',                desc:'Var ‚àí$6K, fans +500.',                              varCost:6000,  fans:+500 },
        { id:'mkt_charity',          title:'Charity Showmatch ($10K)',              desc:'Var ‚àí$10K, fans +800, brand +0.05.',                varCost:10000, fans:+800, brandDelta:+0.05 },
        { id:'mkt_meet_greet',       title:'In-Person Meet & Greet ($12K)',         desc:'Var ‚àí$12K, fans +700, morale +2.',                  varCost:12000, fans:+700, morale:+2 },
        { id:'mkt_premium_brand',    title:'Premium Brand Campaign ($25K)',         desc:'Var ‚àí$25K, brand +0.08, fans +900.',                varCost:25000, brandDelta:+0.08, fans:+900 },
        { id:'mkt_tiktok_challenge', title:'TikTok Challenge ($7K)',                desc:'Var ‚àí$7K, fans +900, brand +0.03.',                 varCost:7000,  fans:+900, brandDelta:+0.03 },
        { id:'mkt_club_partners',    title:'Partner with College Esports Clubs ($9K)',desc:'Var ‚àí$9K, fans +1000, brand +0.03.',             varCost:9000,  fans:+1000, brandDelta:+0.03 },
        { id:'mkt_newsletter',       title:'Launch Email Newsletter ($4K)',         desc:'Var ‚àí$4K, fans +300, better retention.',            varCost:4000,  fans:+300 },
        { id:'mkt_highlight_reel',   title:'Weekly Highlight Reels ($6K)',          desc:'Var ‚àí$6K, fans +600, brand +0.02.',                 varCost:6000,  fans:+600, brandDelta:+0.02 },
        { id:'mkt_memes',            title:'Meme Marketing Push ($3K)',             desc:'Var ‚àí$3K, fans +400, low risk.',                    varCost:3000,  fans:+400 },
        { id:'mkt_roadshow',         title:'Regional Roadshow ($20K)',              desc:'Var ‚àí$20K, fans +1600, brand +0.04.',               varCost:20000, fans:+1600, brandDelta:+0.04 },
        { id:'mkt_sponsor_showcase', title:'Sponsor Showcase Stream ($5K)',         desc:'Var ‚àí$5K, brand +0.05, small fans boost.',          varCost:5000,  brandDelta:+0.05, fans:+300 },
        { id:'mkt_viewing_party',    title:'Offline Viewing Party ($11K)',          desc:'Var ‚àí$11K, fans +900, morale +2.',                  varCost:11000, fans:+900, morale:+2 },
        { id:'mkt_podcast',          title:'Team Podcast Launch ($9K)',             desc:'Var ‚àí$9K, fans +700, brand +0.03.',                 varCost:9000,  fans:+700, brandDelta:+0.03 },
        { id:'mkt_cross_promo',      title:'Cross-Promote with Other Org ($10K)',   desc:'Var ‚àí$10K, fans +1000.',                            varCost:10000, fans:+1000 },
        { id:'mkt_coach_clinic',     title:'Coach-Led Clinic ($8K)',                desc:'Var ‚àí$8K, fans +500, brand +0.02.',                 varCost:8000,  fans:+500, brandDelta:+0.02 },
        { id:'mkt_student_discount', title:'Student Discount Program ($6K)',        desc:'Var ‚àí$6K, fans +600 (college age).',                varCost:6000,  fans:+600 },
        { id:'mkt_loyalty_program',  title:'Fan Loyalty Program ($7K)',             desc:'Var ‚àí$7K, fans +500; retention boost.',             varCost:7000,  fans:+500 },
        { id:'mkt_merch_collab',     title:'Merch Collab with Artist ($18K)',       desc:'Var ‚àí$18K, fans +1200, merch next +$8K.',           varCost:18000, fans:+1200, merchNext:8000 },
        { id:'mkt_giveaway',         title:'Social Media Giveaway ($5K)',           desc:'Var ‚àí$5K, fans +700.',                              varCost:5000,  fans:+700 },
        { id:'mkt_ingame_ads',       title:'In-Game Ad Partnership ($14K)',         desc:'Var ‚àí$14K, brand +0.06, fans +800.',                varCost:14000, brandDelta:+0.06, fans:+800 },
        { id:'mkt_fan_survey',       title:'Fan Survey & Feedback ($4K)',           desc:'Var ‚àí$4K, morale +1, brand +0.02.',                 varCost:4000,  morale:+1, brandDelta:+0.02 },
        { id:'mkt_ugc_campaign',     title:'User-Generated Content Campaign ($6K)', desc:'Var ‚àí$6K, fans +600.',                              varCost:6000,  fans:+600 }
      ],
      ply: [
        { id:'ply_bootcamp',         title:'Intense Bootcamp ($0)',                 desc:'TSR +8; morale ‚àí10; higher injury risk.',            varCost:0,     tsr:+8,  morale:-10, bootcampRisk:true },
        { id:'ply_retreat',          title:'Team Retreat ($10K)',                   desc:'Var ‚àí$10K, morale +10, TSR ‚àí3.',                    varCost:10000, morale:+10, tsr:-3 },
        { id:'ply_balanced',         title:'Balanced Schedule ($0)',                desc:'TSR +2, morale +2.',                                varCost:0,     tsr:+2,  morale:+2 },
        { id:'ply_vod',              title:'VOD Review Focus ($0)',                 desc:'TSR +4, morale ‚àí2.',                                varCost:0,     tsr:+4,  morale:-2 },
        { id:'ply_content_day',      title:'Content Day ($3K)',                     desc:'Var ‚àí$3K, fans +600, morale +1, TSR ‚àí1.',          varCost:3000,  fans:+600, morale:+1, tsr:-1 },
        { id:'ply_mental_coach',     title:'Mental Performance Coach ($12K)',       desc:'Var ‚àí$12K, morale +7.',                             varCost:12000, morale:+7 },
        { id:'ply_substitute',       title:'Trial Substitute Player ($5K)',         desc:'Var ‚àí$5K, TSR +3 short term.',                      varCost:5000,  tsr:+3 },
        { id:'ply_stream_focus',     title:'Stream-First Week ($0)',                desc:'Fans +700, TSR ‚àí2.',                                varCost:0,     fans:+700, tsr:-2 },
        { id:'ply_role_swap',        title:'Experiment Role Swap ($0)',             desc:'TSR +5 if it lands; morale ‚àí3.',                    varCost:0,     tsr:+5,  morale:-3 },
        { id:'ply_health_week',      title:'Health Reset Week ($4K)',               desc:'Var ‚àí$4K, morale +6.',                              varCost:4000,  morale:+6 },
        { id:'ply_solo_queue',       title:'Solo Queue Grind ($0)',                 desc:'TSR +3, morale ‚àí1.',                                varCost:0,     tsr:+3,  morale:-1 },
        { id:'ply_media_training',   title:'Media Training ($6K)',                  desc:'Var ‚àí$6K, brand +0.03, morale +1.',                 varCost:6000,  brandDelta:+0.03, morale:+1 },
        { id:'ply_micro_practice',   title:'Micro Mechanics Practice ($0)',         desc:'TSR +4, morale ‚àí1.',                                varCost:0,     tsr:+4,  morale:-1 },
        { id:'ply_macro_review',     title:'Macro Game Review ($0)',                desc:'TSR +3, morale +0.',                                varCost:0,     tsr:+3 },
        { id:'ply_scrim_block',      title:'Heavy Scrim Block ($0)',                desc:'TSR +6, morale ‚àí4; moderate injury risk.',          varCost:0,     tsr:+6,  morale:-4, bootcampRisk:true },
        { id:'ply_flex_queue',       title:'Flex Queue Night ($2K)',                desc:'Var ‚àí$2K, morale +3, small TSR dip.',               varCost:2000,  morale:+3, tsr:-1 },
        { id:'ply_aim_training',     title:'Aim Training Program ($5K)',            desc:'Var ‚àí$5K, TSR +4.',                                 varCost:5000,  tsr:+4 },
        { id:'ply_community_games',  title:'Community Games with Fans ($3K)',       desc:'Var ‚àí$3K, fans +500, morale +2.',                   varCost:3000,  fans:+500, morale:+2 },
        { id:'ply_off_role_day',     title:'Off-Role Fun Day ($2K)',                desc:'Var ‚àí$2K, morale +4, TSR ‚àí1.',                      varCost:2000,  morale:+4, tsr:-1 },
        { id:'ply_review_coach',     title:'1:1 Coaching Reviews ($7K)',            desc:'Var ‚àí$7K, TSR +3, morale +2.',                      varCost:7000,  tsr:+3,  morale:+2 },
        { id:'ply_language_training',title:'Comms Language Training ($4K)',         desc:'Var ‚àí$4K, TSR +2, brand +0.01.',                    varCost:4000,  tsr:+2,  brandDelta:+0.01 },
        { id:'ply_sleep_research',   title:'Sleep Schedule Optimization ($5K)',     desc:'Var ‚àí$5K, morale +4, TSR +1.',                      varCost:5000,  morale:+4, tsr:+1 },
        { id:'ply_nutrition_workshop',title:'Nutrition Workshop ($4K)',             desc:'Var ‚àí$4K, morale +3.',                              varCost:4000,  morale:+3 },
        { id:'ply_chill_day',        title:'Full Chill Day ($0)',                   desc:'Morale +5, TSR ‚àí2.',                               varCost:0,     morale:+5, tsr:-2 },
        { id:'ply_no_comms',         title:'No-Comms Challenge ($0)',               desc:'Morale +2 (fun), TSR ‚àí1.',                         varCost:0,     morale:+2, tsr:-1 },
        { id:'ply_peer_feedback',    title:'Structured Peer Feedback ($1K)',        desc:'Var ‚àí$1K, morale +2, TSR +1.',                      varCost:1000,  morale:+2, tsr:+1 },
        { id:'ply_captain_workshop', title:'Captain Leadership Workshop ($3K)',     desc:'Var ‚àí$3K, morale +3.',                              varCost:3000,  morale:+3 },
        { id:'ply_clutch_drills',    title:'Clutch Situation Drills ($2K)',         desc:'Var ‚àí$2K, TSR +3.',                                 varCost:2000,  tsr:+3 },
        { id:'ply_tilt_management',  title:'Tilt Management Session ($3K)',         desc:'Var ‚àí$3K, morale +3.',                              varCost:3000,  morale:+3 },
        { id:'ply_sports_day',       title:'Real Sports Day ($5K)',                 desc:'Var ‚àí$5K, morale +5, small TSR buff.',             varCost:5000,  morale:+5, tsr:+1 }
      ]
    };

    function findCard(category, id) {
      const deck = SEASON_DECKS[category] || [];
      return deck.find(c => c.id === id) || null;
    }

    function pickRandomCards(deck, count) {
      const indices = deck.map((_, i) => i);
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      return indices.slice(0, count).map(i => deck[i]);
    }

    // ---------- Rendering ----------
    function renderStartupChoices() {
      const cols = [col1, col2, col3];
      STARTUP_CONFIG.columns.forEach((colCfg, idx) => {
        const fs = cols[idx];
        if (!fs) return;
        fs.innerHTML = '';
        const legend = document.createElement('legend');
        legend.textContent = colCfg.legend;
        fs.appendChild(legend);

        colCfg.options.forEach(opt => {
          const label = document.createElement('label');
          label.className = 'option';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = colCfg.group;
          input.value = opt.id;

          const body = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'opt-main';
          title.textContent = opt.title;
          const helper = document.createElement('div');
          helper.className = 'helper';
          helper.textContent = opt.desc;

          body.appendChild(title);
          body.appendChild(helper);
          label.appendChild(input);
          label.appendChild(body);
          fs.appendChild(label);
        });
      });

      $$('input[name=g1], input[name=g2], input[name=g3]').forEach(inp => {
        inp.addEventListener('change', previewEffects);
      });
      previewEffects();
    }

    function renderSeasonChoices() {
      const opsCards = pickRandomCards(SEASON_DECKS.ops, 3);
      const mktCards = pickRandomCards(SEASON_DECKS.mkt, 3);
      const plyCards = pickRandomCards(SEASON_DECKS.ply, 3);

      const groups = [
        { legend: '1) Operations', name: 'g1', cards: opsCards },
        { legend: '2) Marketing',  name: 'g2', cards: mktCards },
        { legend: '3) Player Focus', name: 'g3', cards: plyCards }
      ];
      const cols = [col1, col2, col3];

      groups.forEach((g, idx) => {
        const fs = cols[idx];
        if (!fs) return;
        fs.innerHTML = '';
        const legend = document.createElement('legend');
        legend.textContent = g.legend;
        fs.appendChild(legend);

        g.cards.forEach(card => {
          const label = document.createElement('label');
          label.className = 'option';
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = g.name;
          input.value = card.id;

          const body = document.createElement('div');
          const title = document.createElement('div');
          title.className = 'opt-main';
          title.textContent = card.title;
          const helper = document.createElement('div');
          helper.className = 'helper';
          helper.textContent = card.desc;

          body.appendChild(title);
          body.appendChild(helper);
          label.appendChild(input);
          label.appendChild(body);
          fs.appendChild(label);
        });
      });

      $$('input[name=g1], input[name=g2], input[name=g3]').forEach(inp => {
        inp.addEventListener('change', previewEffects);
      });
      previewEffects();
    }

    function renderDecisionsForPhase() {
      if (S.phase === 'startup') {
        renderStartupChoices();
      } else if (S.phase === 'season') {
        renderSeasonChoices();
      }
    }

    function scenarioText() {
      if (S.phase === 'startup') {
        return 'Startup ‚Äî Make your founding decisions: space, equipment, and players will define your ceiling.';
      }
      const flavors = [
        'Scrim results leak and social media expects big results.',
        'A rival org signs a star player and everyone is watching your response.',
        'A major game patch reshapes the meta overnight.',
        'Travel delays and PC issues test your logistics.',
        'A clutch play from your team goes viral on TikTok.',
        'Analysts highlight your org as a dark-horse contender.'
      ];
      const i = (S.turn + S.fans + S.tsr) % flavors.length;
      return `Season ${S.season} ‚Ä¢ Turn ${S.turn} ‚Äî ${flavors[i]}`;
    }

    function winProbability() {
      const moraleMult = clamp(S.morale / 100, 0.3, 1.2);
      const equipMult = 1 + (S.equipmentLevel * 0.05);
      const baseOpp = S.rank === 3 ? 65 : S.rank === 2 ? 75 : 85;
      const opp = Math.max(40, baseOpp);
      const raw = (S.tsr * moraleMult * equipMult) / opp;
      return clamp(raw, 0.05, 0.95);
    }

    function academicFeedback(pl, ctx) {
      const { revenue, expenses, fixed, variable } = ctx;
      if (pl < 0 && revenue < fixed) {
        return 'Your revenue did not reach the break-even point; fixed costs were not covered by your contribution margin.';
      }
      if (pl < 0 && variable > fixed) {
        return 'High variable costs eroded your margin this turn; consider tightening discretionary spending like events and travel.';
      }
      if (pl >= 0 && revenue > expenses) {
        return 'Positive contribution margin covered fixed costs and produced profit‚Äîreflect on which decisions drove revenue.';
      }
      if (pl < 0) {
        return 'A net loss increased financial pressure; explore boosting revenue-generating assets or reducing liabilities.';
      }
      return 'You maintained stable finances this turn; continue balancing assets that drive recurring revenue with cost control.';
    }

    function updateStatus() {
      kTurn.textContent = S.turn;
      kPhase.textContent = S.phase === 'startup'
        ? 'Startup (Founding Decisions)'
        : 'Season Play';

      kSeason.textContent = S.season;
      kMode.textContent = S.mode === 'standard' ? 'Standard' : 'Extended';
      kCash.textContent = fmtMoney(S.cash);
      kFixed.textContent = fmtMoney(S.salaries);
      kFans.textContent = S.fans.toLocaleString();
      kTSR.textContent = `${S.tsr} / 100`;
      kMorale.textContent = `${S.morale} / 100`;
      kRank.textContent = rankName(S.rank);
      kDebt.textContent = fmtMoney(S.debt);

      const wp = winProbability();
      winBar.style.width = `${(wp * 100).toFixed(0)}%`;
      winPct.textContent = `${(wp * 100).toFixed(0)}%`;

      const pct = clamp(S.turn / S.maxStandardTurns, 0, 1);
      turnProgressPct.textContent = `${(pct * 100).toFixed(0)}%`;

      modeBadge.textContent = S.mode === 'standard' ? 'Standard Mode' : 'Extended Mode';
      modeBadge.className = `badge-mode ${S.mode}`;
      elScenario.textContent = scenarioText();
    }

    function appendLog(lines) {
      const t = Array.isArray(lines) ? lines.join('\n') : String(lines);
      elLog.textContent = (t + '\n' + elLog.textContent).trim();
    }

    function confetti(n = 18) {
      const c = document.createElement('div');
      c.style.position = 'fixed';
      c.style.left = '0';
      c.style.top = '0';
      c.style.width = '100vw';
      c.style.height = '0';
      c.style.pointerEvents = 'none';
      document.body.appendChild(c);
      const glyphs = ['üéâ','‚ú®','üí•','üåü'];
      for (let i = 0; i < n; i++) {
        const s = document.createElement('div');
        s.textContent = glyphs[i % glyphs.length];
        s.style.position = 'absolute';
        s.style.left = (Math.random() * 100) + 'vw';
        s.style.top = '-10px';
        s.style.fontSize = (12 + Math.random() * 18) + 'px';
        s.style.animation = `fall ${2 + Math.random()*2}s linear forwards`;
        c.appendChild(s);
        setTimeout(() => s.remove(), 4000);
      }
      setTimeout(() => c.remove(), 4200);
    }

    function setNameFromInput() {
      S.name = (elName?.value || '').trim();
      save();
    }

    // ---- Decision selection and preview ----
    function getSelections() {
      const d1 = document.querySelector('input[name=g1]:checked')?.value || null;
      const d2 = document.querySelector('input[name=g2]:checked')?.value || null;
      const d3 = document.querySelector('input[name=g3]:checked')?.value || null;
      return { d1, d2, d3 };
    }

    function previewEffects() {
      const { d1, d2, d3 } = getSelections();
      elRun.disabled = !(d1 && d2 && d3);
    }

    // ---- Startup (single turn) ----
    function applyStartupTurn(sel) {
      const log = [];
      let upfrontCost = 0;

      // Facilities
      if (sel.d1 === 'fac_shared') {
        S.facilityLevel = 1;
        S.salaries += 5000;
        S.morale += 3;
        upfrontCost += 30000;
        log.push('üè¢ You picked a Shared Office: fixed +$5K/turn, morale +3, modest setup cost.');
      } else if (sel.d1 === 'fac_leased') {
        S.facilityLevel = 2;
        S.salaries += 10000;
        S.morale += 5;
        S.tsr += 3;
        upfrontCost += 60000;
        log.push('üè¢ You leased a dedicated Facility: fixed +$10K/turn, morale and TSR up, higher startup cost.');
      } else if (sel.d1 === 'fac_house') {
        S.facilityLevel = 3;
        S.salaries += 18000;
        S.morale += 8;
        S.tsr += 5;
        upfrontCost += 100000;
        log.push('üè† You built a Gaming House: big fixed +$18K/turn, morale and TSR potential greatly increased.');
      }

      // Equipment
      if (sel.d2 === 'eq_basic') {
        S.equipmentLevel = 1;
        upfrontCost += 20000;
        log.push('üñ•Ô∏è Basic PCs installed: low cost, limited performance.');
      } else if (sel.d2 === 'eq_pro') {
        S.equipmentLevel = 2;
        S.tsr += 5;
        S.brandReputation += 0.05;
        upfrontCost += 50000;
        log.push('üñ•Ô∏è Pro-level setup: TSR +5, brand reputation slightly up.');
      } else if (sel.d2 === 'eq_premium') {
        S.equipmentLevel = 3;
        S.tsr += 5;
        S.brandReputation += 0.1;
        S.fans += 500;
        upfrontCost += 80000;
        log.push('üé¨ Premium streaming rig: TSR +5, brand +0.1, starting fans +500 from content hype.');
      }

      // Roster
      if (sel.d3 === 'ros_local') {
        S.salaries += 5000;
        S.morale += 5;
        upfrontCost += 10000;
        log.push('üéÆ Local rookies signed: low salaries, high morale potential.');
      } else if (sel.d3 === 'ros_mix') {
        S.salaries += 12000;
        S.tsr += 5;
        S.morale += 2;
        S.fans += 500;
        upfrontCost += 20000;
        log.push('üéÆ Semi-pro mix roster: balanced salaries, TSR +5, moderate fan interest.');
      } else if (sel.d3 === 'ros_stars') {
        S.salaries += 25000;
        S.tsr += 10;
        S.morale -= 2;
        S.fans += 2000;
        upfrontCost += 40000;
        log.push('üåü Star free agents: high salaries, TSR +10, +2,000 fans but morale is more fragile.');
      }

      S.cash -= upfrontCost;
      S.tsr = clamp(Math.round(S.tsr), 0, 100);
      S.morale = clamp(Math.round(S.morale), 0, 100);
      if (S.brandReputation < 0.7) S.brandReputation = 0.7;
      if (S.brandReputation > 1.2) S.brandReputation = 1.2;

      appendLog([
        'Startup summary:',
        ...log,
        `Total initial investment: ${fmtMoney(upfrontCost)}`,
        '‚îÄ'.repeat(40)
      ]);

      S.phase = 'season';
      S.turn = 1;
    }

    // ---- Problem Events ----
    function maybeTriggerProblemEvent(log, plyCard) {
      if (S.problemCooldown > 0) {
        S.problemCooldown -= 1;
        return;
      }

      let baseChance = 0.15;
      if (plyCard && plyCard.bootcampRisk) baseChance += 0.10;
      if (S.facilityCondition < 70) baseChance += 0.05;
      if (S.equipmentLevel < 2) baseChance += 0.05;
      if (S.streak <= 0) baseChance += 0.05;
      baseChance = clamp(baseChance, 0.05, 0.4);
      const roll = Math.random();
      if (roll >= baseChance) return;

      const pool = [];
      const injuryWeight = plyCard && plyCard.bootcampRisk ? 3 : 1;
      for (let i = 0; i < injuryWeight; i++) pool.push('injury');
      const streamWeight = (S.equipmentLevel <= 1 || S.facilityCondition < 60) ? 3 : 1;
      for (let i = 0; i < streamWeight; i++) pool.push('stream');
      const sponsorWeight = (S.streak <= 0 || S.brandReputation < 0.9) ? 3 : 1;
      for (let i = 0; i < sponsorWeight; i++) pool.push('sponsor');
      const facilityWeight = (S.facilityLevel >= 2 && S.facilityCondition < 75) ? 3 : 1;
      for (let i = 0; i < facilityWeight; i++) pool.push('facility');

      if (!pool.length) return;
      const type = pool[Math.floor(Math.random() * pool.length)];

      if (type === 'injury') {
        S.tsr -= 4;
        S.morale -= 3;
        S.tsr = clamp(S.tsr, 0, 100);
        S.morale = clamp(S.morale, 0, 100);
        const cause = plyCard && plyCard.bootcampRisk
          ? 'After your intense training block'
          : 'After a stretch of hard scrims';
        log.push(`üöë Problem Event: ${cause}, one player tweaks a wrist. TSR ‚àí4, morale ‚àí3.`);
      } else if (type === 'stream') {
        const before = S.fans;
        S.fans = Math.max(0, Math.round(S.fans * 0.97));
        const infra = S.equipmentLevel <= 1
          ? 'Your budget streaming setup struggled'
          : 'Facility issues disrupted your stream';
        log.push(`üì° Problem Event: ${infra}. Fans ${before.toLocaleString()} ‚Üí ${S.fans.toLocaleString()} (‚àí3%).`);
      } else if (type === 'sponsor') {
        S.brandReputation -= 0.05;
        S.brandReputation = clamp(S.brandReputation, 0.7, 1.2);
        const streakText = S.streak <= 0 ? 'recent results' : 'inconsistent branding';
        log.push(`üíº Problem Event: Sponsor is concerned about ${streakText}. Brand reputation slightly down.`);
      } else if (type === 'facility') {
        S.facilityCondition -= 8;
        S.facilityCondition = clamp(S.facilityCondition, 0, 100);
        log.push('üèö Problem Event: Because your facility has been neglected, you face recurring issues. Facility condition ‚àí8.');
      }

      S.problemCooldown = 2;
    }

    // ---- Season Turn ----
    function applySeasonTurn(cards) {
      const { ops, mkt, ply } = cards;
      const log = [];

      S.undoStack.push(JSON.stringify(S));
      if (S.undoStack.length > 10) S.undoStack.shift();
      elUndo.disabled = S.undoStack.length === 0;

      const minis = [
        () => 'üéâ Birthday stream boosts vibes slightly.',
        () => 'üìπ Behind-the-scenes vlog builds fan connection.',
        () => 'üõ† Patch tweak nudges the meta; your comp needs adjustment.',
        () => 'üì∞ Local article puts your rookie story in the spotlight.'
      ];
      log.push(minis[Math.floor(Math.random() * minis.length)]());

      let variable = 0;
      let newlyQueuedMerch = 0;

      function applyCard(card, label) {
        if (!card) return;
        if (card.varCost) { variable += card.varCost; }
        if (card.fixedDelta) { S.salaries += card.fixedDelta; }
        if (card.tsr) { S.tsr += card.tsr; }
        if (card.morale) { S.morale += card.morale; }
        if (card.fans) { S.fans += card.fans; }
        if (card.brandDelta) { S.brandReputation += card.brandDelta; }
        if (card.facilityCond) { S.facilityCondition += card.facilityCond; }
        if (card.merchNext) { newlyQueuedMerch += card.merchNext; }

        const costPart = card.varCost ? `Var ${card.varCost > 0 ? '‚àí' : '+'}${fmtMoney(Math.abs(card.varCost))}; ` : '';
        const fixedPart = card.fixedDelta ? `Fixed ${card.fixedDelta > 0 ? '+' : '‚àí'}${fmtMoney(Math.abs(card.fixedDelta))}/turn; ` : '';
        log.push(`${label}: ${card.title} (${costPart}${fixedPart}effects applied).`);
      }

      applyCard(ops, '‚öôÔ∏è Operations');
      applyCard(mkt, 'üì£ Marketing');
      applyCard(ply, 'üéØ Player Focus');

      S.tsr = clamp(Math.round(S.tsr), 0, 100);
      S.morale = clamp(Math.round(S.morale), 0, 100);

      maybeTriggerProblemEvent(log, ply);

      const moraleMult = clamp(S.morale / 100, 0.3, 1.2);
      const equipMult = 1 + (S.equipmentLevel * 0.05);
      const baseOpp = S.rank === 3 ? 65 : S.rank === 2 ? 75 : 85;
      const jitter = (Math.random() * 10) - 5;
      const oppDiff = Math.max(40, baseOpp + jitter);
      const pWin = clamp((S.tsr * moraleMult * equipMult) / oppDiff, 0.05, 0.95);
      const isWin = Math.random() < pWin;

      const prizeTable = { 1: 60000, 2: 35000, 3: 20000 };
      let prizeMoney = isWin ? prizeTable[S.rank] : 0;

      if (isWin) {
        S.streak = (S.streak || 0) + 1;
        S.fans += 1500;
        confetti(20);
        log.push(`üèÜ MATCH RESULT: WIN (p=${(pWin*100).toFixed(1)}%). Prize ${fmtMoney(prizeMoney)}, fans +1,500.`);
      } else {
        S.streak = 0;
        variable += 10000;
        const before = S.fans;
        S.fans = Math.max(0, Math.round(S.fans * 0.95));
        log.push(`üíî MATCH RESULT: LOSS (p=${(pWin*100).toFixed(1)}%). Sponsor penalty ‚àí$10,000; fans ${before.toLocaleString()} ‚Üí ${S.fans.toLocaleString()} (‚àí5%).`);
      }

      const prevQueuedMerch = S.merchNext || 0;
      const baseSponsor = S.rank === 1 ? 30000 : S.rank === 2 ? 18000 : 9000;
      const tierBonus = S.sponsorshipTier * 5000;
      const brandMult = clamp(S.brandReputation, 0.7, 1.2);
      const sponsorships = Math.round((baseSponsor + tierBonus + Math.max(0, S.tsr - 50) * 120) * brandMult);
      const merchRevenue = prevQueuedMerch;
      const facilityCost = S.facilityLevel * 5000;
      const eqMaintenance = S.equipmentLevel * 2000;
      const fixed = S.salaries + facilityCost + eqMaintenance;
      const travel = 5000;
      variable += travel;

      const revenue = sponsorships + merchRevenue + prizeMoney;
      const expenses = fixed + variable;
      let pl = revenue - expenses;

      if (S.cash + pl < 0) {
        const deficit = -(S.cash + pl);
        S.debt += deficit;
        S.cash = 0;
        pl = -deficit;
      } else {
        S.cash += pl;
      }

      if (S.debt > 0) {
        const interest = Math.round(S.debt * 0.05);
        S.debt += interest;
        S.cash -= interest;
        log.push(`üè¶ Debt interest applied: ‚àí${fmtMoney(interest)} this turn.`);
      }

      S.merchNext = newlyQueuedMerch;

      let promoted = false;
      if (S.rank === 3 && S.tsr >= 70 && S.fans >= 7000) { S.rank = 2; promoted = true; }
      else if (S.rank === 2 && S.tsr >= 80 && S.fans >= 12000) { S.rank = 1; promoted = true; }
      if (promoted) {
        S.sponsorshipTier = Math.min(4, S.sponsorshipTier + 1);
        log.push('üöÄ Rank update: You were promoted. Sponsorship tier improved.');
      }

      const fb = academicFeedback(pl, { revenue, expenses, fixed, variable });
      elFinance.innerHTML =
        `Total Revenue = Sponsorships (${fmtMoney(sponsorships)}) + Merch (${fmtMoney(merchRevenue)}) + Prize Money (${fmtMoney(prizeMoney)}) = <b>${fmtMoney(revenue)}</b><br>` +
        `Total Expenses = Fixed (${fmtMoney(fixed)}) + Variable (${fmtMoney(variable)}) = <b>${fmtMoney(expenses)}</b><br>` +
        `Profit/Loss (P/L) = <b>${fmtMoney(pl)}</b><br>` +
        `Updated Cash Reserves: <b>${fmtMoney(S.cash)}</b> ¬∑ Debt: <b>${fmtMoney(S.debt)}</b>`;
      elFeedback.textContent = 'Academic Feedback: ' + fb;

            const decisions = {
        ops: ops ? ops.title : null,
        mkt: mkt ? mkt.title : null,
        ply: ply ? ply.title : null
      };

      const bigFlags = {
        opsBig: ops && (((ops.varCost || 0) >= 15000) || ((ops.fixedDelta || 0) > 0)),
        mktBig: mkt && (((mkt.varCost || 0) >= 15000) || ((mkt.merchNext || 0) > 0)),
        plyBig: ply && (((ply.varCost || 0) >= 10000) || ply.bootcampRisk)
      };

      S.history.push({
        turn: S.turn,
        phase: S.phase,
        season: S.season,
        cash: S.cash,
        salaries: S.salaries,
        fans: S.fans,
        tsr: S.tsr,
        morale: S.morale,
        rank: S.rank,
        debt: S.debt,
        revenue: { sponsorships, merchSales: merchRevenue, prizeMoney },
        expenses: { fixed, variable },
        pl,
        decisions,
        isWin,
        bigFlags
      });

      if (S.cash < 0) S.negCashStreak = (S.negCashStreak || 0) + 1;
      else S.negCashStreak = 0;

      if (S.negCashStreak >= 2) {
        gameOver('Financial Ruin', 'Cash reserves were below $0 for two consecutive turns.');
        return;
      }
      if (S.morale <= 0) {
        gameOver('Mutiny', 'Player morale fell to 0. The roster refuses to compete.');
        return;
      }

      appendLog([
        `Season ${S.season} ‚Äî Turn ${S.turn} summary:`,
        ...log,
        '‚îÄ'.repeat(40)
      ]);

      S.turn += 1;
    }

    function checkMastery() {
      const mastery = (
        S.rank === 1 &&
        S.cash >= 1000000 &&
        S.fans >= 50000 &&
        S.tsr >= 85 &&
        S.morale >= 80
      );
      if (mastery) S.mastered = true;
      return mastery;
    }
    function renderAnalytics() {
      if (!S.history || !S.history.length) return;
      if (typeof Chart === 'undefined') return;
      if (!cashChartCanvas || !tsrChartCanvas) return;

      const labels = S.history.map(h => `T${h.turn}`);
      const actualCash = S.history.map(h => h.cash);
      const actualTSR = S.history.map(h => h.tsr);

      // Simple ‚Äúaverage player‚Äù baselines
      const avgCash = [];
      const avgTSR = [];
      let baselineCash = 250000;
      S.history.forEach((h, i) => {
        baselineCash += 10000; // assume a modest +10K per turn ‚Äúaverage‚Äù
        avgCash.push(baselineCash);
        avgTSR.push(60 + Math.min(i * 2, 25)); // TSR slowly trending upward
      });

      // Identify key moments (big decisions)
      const keyMoments = S.history
        .map((h, idx) => ({ h, idx }))
        .filter(({ h }) => h.bigFlags && (h.bigFlags.opsBig || h.bigFlags.mktBig || h.bigFlags.plyBig));

      // Clear lists
      if (keyMomentsList) keyMomentsList.innerHTML = '';
      if (whatIfList) whatIfList.innerHTML = '';

      // Populate key decision moments (up to last 6 interesting turns)
      keyMoments.slice(-6).forEach(({ h }) => {
        const li = document.createElement('li');
        const titles = [];
        if (h.decisions.ops && h.bigFlags.opsBig) titles.push(`Ops: "${h.decisions.ops}"`);
        if (h.decisions.mkt && h.bigFlags.mktBig) titles.push(`Mkt: "${h.decisions.mkt}"`);
        if (h.decisions.ply && h.bigFlags.plyBig) titles.push(`Player: "${h.decisions.ply}"`);

        li.textContent =
          `Turn ${h.turn}: ` +
          (titles.length ? titles.join(' ¬∑ ') : 'Notable impact on cash/TSR/fans.') +
          ` ‚Äî Cash ${fmtMoney(h.cash)}, TSR ${h.tsr}, Fans ${h.fans.toLocaleString()}.`;
        keyMomentsList?.appendChild(li);
      });

      // ‚ÄúWhat if?‚Äù scenarios ‚Äì very rough, local comparisons
      function bestCheaperAlt(deck, actualTitle) {
        const actual = deck.find(c => c.title === actualTitle);
        if (!actual) return null;
        return deck.reduce((best, c) => {
          if (c.title === actualTitle) return best;
          if (!best) return c;
          return (c.varCost || 0) < (best.varCost || 0) ? c : best;
        }, null);
      }

      keyMoments.slice(-3).forEach(({ h }) => {
        if (!h.decisions) return;
        const li = document.createElement('li');
        let text = `Turn ${h.turn}: `;

        // Try one category for each scenario, rotating
        if (h.bigFlags.opsBig && h.decisions.ops) {
          const alt = bestCheaperAlt(SEASON_DECKS.ops, h.decisions.ops);
          if (alt) {
            const actual = SEASON_DECKS.ops.find(c => c.title === h.decisions.ops);
            const cashDiff = (actual.varCost || 0) - (alt.varCost || 0);
            const moraleDiff = (actual.morale || 0) - (alt.morale || 0);
            const tsrDiff = (actual.tsr || 0) - (alt.tsr || 0);
            text += `You chose "${h.decisions.ops}". If you had picked "${alt.title}" instead, your cash might be about ${fmtMoney(cashDiff)} higher, with morale ~${moraleDiff >= 0 ? '-' : '+'}${Math.abs(moraleDiff)} and TSR ~${tsrDiff >= 0 ? '-' : '+'}${Math.abs(tsrDiff)} different (holding other decisions constant).`;
          }
        } else if (h.bigFlags.mktBig && h.decisions.mkt) {
          const alt = bestCheaperAlt(SEASON_DECKS.mkt, h.decisions.mkt);
          if (alt) {
            const actual = SEASON_DECKS.mkt.find(c => c.title === h.decisions.mkt);
            const cashDiff = (actual.varCost || 0) - (alt.varCost || 0);
            const fanDiff = (actual.fans || 0) - (alt.fans || 0);
            text += `You ran "${h.decisions.mkt}". If you had chosen "${alt.title}", you might have saved about ${fmtMoney(cashDiff)} but ended with roughly ${fanDiff >= 0 ? 'fewer' : 'more'} ${Math.abs(fanDiff)} fans (all else equal).`;
          }
        } else if (h.bigFlags.plyBig && h.decisions.ply) {
          const alt = bestCheaperAlt(SEASON_DECKS.ply, h.decisions.ply);
          if (alt) {
            const actual = SEASON_DECKS.ply.find(c => c.title === h.decisions.ply);
            const cashDiff = (actual.varCost || 0) - (alt.varCost || 0);
            const moraleDiff = (actual.morale || 0) - (alt.morale || 0);
            const tsrDiff = (actual.tsr || 0) - (alt.tsr || 0);
            text += `You chose player plan "${h.decisions.ply}". A lighter option like "${alt.title}" might have changed cash by ~${fmtMoney(cashDiff)} and shifted morale/TSR by about ${moraleDiff >= 0 ? '-' : '+'}${Math.abs(moraleDiff)} morale and ${tsrDiff >= 0 ? '-' : '+'}${Math.abs(tsrDiff)} TSR.`;
          }
        }

        if (text.endsWith(`Turn ${h.turn}: `)) {
          text += 'Changing this decision would have altered cash flow and TSR, but the exact impact is complex because later turns build on it.';
        }
        li.textContent = text;
        whatIfList?.appendChild(li);
      });

      // Build charts
      if (cashChartInstance) cashChartInstance.destroy();
      if (tsrChartInstance) tsrChartInstance.destroy();

      cashChartInstance = new Chart(cashChartCanvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Your Cash',
              data: actualCash,
              tension: 0.25,
              borderWidth: 2,
              pointRadius: 3
            },
            {
              label: 'Average Player (Estimate)',
              data: avgCash,
              borderDash: [4,3],
              tension: 0.25,
              borderWidth: 1.5,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e5e7ff', font: { size: 11 } } },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { ticks: { color:'#9ca3ff', font:{size:10} }, grid:{display:false} },
            y: { ticks: { color:'#9ca3ff', font:{size:10} }, grid:{color:'#1f293b'} }
          }
        }
      });

      tsrChartInstance = new Chart(tsrChartCanvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Your TSR',
              data: actualTSR,
              tension: 0.25,
              borderWidth: 2,
              pointRadius: 3
            },
            {
              label: 'Average TSR (Estimate)',
              data: avgTSR,
              borderDash: [4,3],
              tension: 0.25,
              borderWidth: 1.5,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#e5e7ff', font: { size: 11 } } },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { ticks: { color:'#9ca3ff', font:{size:10} }, grid:{display:false} },
            y: {
              suggestedMin: 40,
              suggestedMax: 100,
              ticks: { color:'#9ca3ff', font:{size:10} },
              grid:{color:'#1f293b'}
            }
          }
        }
      });
    }

    
    function finishSeason(reason) {
      S.phase = 'ended';
      S.endedReason = reason || 'standard';

      const endingCash = S.cash;
      const endingRank = S.rank;
      const endingFans = S.fans;
      const profit = endingCash - START.cash;
      const avgTSR = S.history.length
        ? Math.round(S.history.reduce((sum,h)=>sum+h.tsr,0)/S.history.length)
        : S.tsr;
      const avgMorale = S.history.length
        ? Math.round(S.history.reduce((sum,h)=>sum+h.morale,0)/S.history.length)
        : S.morale;

      const rankSub = endingRank === 1 ? 100 : endingRank === 2 ? 70 : 40;
      const profitSub = (() => {
        const min = -150000;
        const max = 300000;
        const pct = clamp((profit - min) / (max - min), 0, 1);
        return Math.round(pct * 100);
      })();
      const fanSub = clamp(Math.round((endingFans / 50000) * 100), 0, 100);
      const moraleSub = clamp(Math.round((avgTSR + avgMorale)/2), 0, 100);
      const debtSub = S.debt <= 0 ? 100 : clamp(100 - Math.round(S.debt/50000)*20, 0, 100);

      const finalScore = Math.round(
        rankSub   * 0.25 +
        profitSub * 0.30 +
        fanSub    * 0.20 +
        moraleSub * 0.15 +
        debtSub   * 0.10
      );

      const student = S.name && S.name.trim() ? S.name.trim() : 'Manager X';

      const lines = [];
      lines.push(`STOP the turn-based simulation. Session complete (${reason}).`);
      lines.push('');
      lines.push(`Student: ${student}`);
      lines.push(`Seasons Played: ${S.season}`);
      lines.push(`Final Cash: ${fmtMoney(endingCash)}`);
      lines.push(`Final Team Rank: ${rankName(endingRank)}`);
      lines.push(`Final Fan Base: ${endingFans.toLocaleString()} followers`);
      lines.push(`Average TSR: ${avgTSR}`);
      lines.push(`Average Morale: ${avgMorale}`);
      lines.push(`Final Debt: ${fmtMoney(S.debt)}`);
      lines.push('');
      lines.push('Score Breakdown (0‚Äì100):');
      lines.push(`  Rank Progress (25%): ${rankSub} ‚Üí ${(rankSub*0.25).toFixed(1)}`);
      lines.push(`  Profit / Cash (30%): ${profitSub} ‚Üí ${(profitSub*0.30).toFixed(1)}`);
      lines.push(`  Fan Growth (20%):   ${fanSub} ‚Üí ${(fanSub*0.20).toFixed(1)}`);
      lines.push(`  TSR & Morale (15%): ${moraleSub} ‚Üí ${(moraleSub*0.15).toFixed(1)}`);
      lines.push(`  Debt Mgmt (10%):    ${debtSub} ‚Üí ${(debtSub*0.10).toFixed(1)}`);
      lines.push('');
      lines.push(`Final Score: ${finalScore} / 100`);
      lines.push('');

      const avoidedRuin = (S.negCashStreak || 0) < 2 && !(endingCash < 0);
      const balanced = (avgTSR >= 60 && avgMorale >= 60) || (profit > 0 && endingRank <= 2);
      const profitable = profit > 0;
      const a = avoidedRuin ? 'You avoided financial ruin' : 'You flirted with financial ruin or relied heavily on debt';
      const b = balanced ? 'balanced short-term performance with long-term capability building' : 'over-weighted either short-term pushes or long-term investments';
      const c = profitable ? 'your cumulative revenues exceeded expenses to produce overall profit' : 'expenses ultimately outpaced revenues, yielding a loss';
      let note = '';
      if (endingCash < 0 && (S.negCashStreak || 0) < 2) {
        note = ' Note: You ended with negative cash but avoided two consecutive negative turns.';
      }
      if (S.mastered) {
        note += ' You also achieved Mastery by reaching Tier 1 with strong finances, fans, TSR, and morale.';
      }
      const assessment = `${a}, ${b}, and ${c}. Consider how fixed versus variable costs and debt shaped your break-even point and liquidity over time.${note}`;

      lines.push('Final Assessment:');
      lines.push(assessment);

      if (reason === 'mastery') {
        lines.push('');
        lines.push('You have mastered all core categories for this simulation. Further play is optional and purely exploratory.');
      }

      elGame.style.display = 'none';
      elIntro.style.display = 'none';
      elFinal.style.display = 'block';
      elFinalText.textContent = lines.join('\n');

      if (reason === 'standard') {
        elContinueExtended.style.display = 'inline-flex';
      } else {
        elContinueExtended.style.display = 'none';
      }
      renderAnalytics();
      save();
    }

    function gameOver(reason, detail) {
      S.phase = 'ended';
      S.endedReason = reason;
      const text =
        `GAME OVER ‚Äî ${reason}\n` +
        `${detail}\n\n` +
        `Final Cash: ${fmtMoney(S.cash)}\n` +
        `Fans: ${S.fans.toLocaleString()}\n` +
        `Rank: ${rankName(S.rank)}\n` +
        `Turns played: ${S.turn}`;
      elGame.style.display = 'none';
      elIntro.style.display = 'none';
      elFinal.style.display = 'block';
      elFinalText.textContent = text;
      elContinueExtended.style.display = 'none';
      renderAnalytics();
      save();
    }

    // ---- Events & wiring ----
    elName?.addEventListener('input', setNameFromInput);

    elReset?.addEventListener('click', () => {
      localStorage.removeItem('mgrx_v2_autosave');
      S = { ...START };
      if (elName) elName.value = '';
      elIntro.style.display = 'block';
      elGame.style.display = 'none';
      elFinal.style.display = 'none';
      promptWrap.style.display = 'none';
      elLog.textContent = '';
    });

    elPrint?.addEventListener('click', () => window.print());
    elPDF?.addEventListener('click', () => window.print());

    elStart?.addEventListener('click', () => {
      setNameFromInput();
      S = { ...START, name: S.name };
      elIntro.style.display = 'none';
      elFinal.style.display = 'none';
      elGame.style.display = 'block';
      renderDecisionsForPhase();
      updateStatus();
      save();
    });

    elRandom?.addEventListener('click', () => {
      const pickRandom = (name) => {
        const list = $$(`input[name=${name}]`);
        if (list.length) list[Math.floor(Math.random() * list.length)].checked = true;
      };
      pickRandom('g1'); pickRandom('g2'); pickRandom('g3');
      previewEffects();
    });

    elRun?.addEventListener('click', () => {
      const sel = getSelections();
      if (!(sel.d1 && sel.d2 && sel.d3)) return;

      if (S.phase === 'startup') {
        applyStartupTurn(sel);
      } else if (S.phase === 'season') {
        const opsCard = findCard('ops', sel.d1);
        const mktCard = findCard('mkt', sel.d2);
        const plyCard = findCard('ply', sel.d3);
        applySeasonTurn({ ops: opsCard, mkt: mktCard, ply: plyCard });
      }

      $$('input[name=g1], input[name=g2], input[name=g3]').forEach(inp => inp.checked = false);
      elRun.disabled = true;

      if (S.phase === 'season') {
        if (checkMastery()) {
          finishSeason('mastery');
          return;
        }
        if (S.mode === 'standard' && S.turn > S.maxStandardTurns) {
          promptWrap.style.display = 'flex';
        }
      }

      if (S.phase !== 'ended') {
        renderDecisionsForPhase();
        updateStatus();
        save();
      }
    });

    elUndo?.addEventListener('click', () => {
      const snap = S.undoStack.pop();
      if (!snap) return;
      S = JSON.parse(snap);
      elUndo.disabled = S.undoStack.length === 0;
      renderDecisionsForPhase();
      updateStatus();
      save();
    });

    elEndEarly?.addEventListener('click', () => {
      finishSeason('retire');
    });

    btnEndStandard?.addEventListener('click', () => {
      promptWrap.style.display = 'none';
      finishSeason('standard');
    });
    btnGoExtended?.addEventListener('click', () => {
      promptWrap.style.display = 'none';
      S.mode = 'extended';
      modeBadge.textContent = 'Extended Mode';
      modeBadge.className = 'badge-mode extended';
      renderDecisionsForPhase();
      updateStatus();
      save();
    });
    btnCancelPrompt?.addEventListener('click', () => {
      promptWrap.style.display = 'none';
      renderDecisionsForPhase();
      updateStatus();
    });

    elContinueExtended?.addEventListener('click', () => {
      S.mode = 'extended';
      S.phase = 'season';
      elFinal.style.display = 'none';
      elGame.style.display = 'block';
      renderDecisionsForPhase();
      updateStatus();
      save();
    });

    document.addEventListener('keydown', (e) => {
      if (!elGame || elGame.style.display === 'none') return;
      const k = e.key;
      const map = {
        '1': ['g1', 0], '2': ['g1', 1], '3': ['g1', 2],
        '4': ['g2', 0], '5': ['g2', 1], '6': ['g2', 2],
        '7': ['g3', 0], '8': ['g3', 1], '9': ['g3', 2]
      };
      if (map[k]) {
        const [name, idx] = map[k];
        const list = $$(`input[name=${name}]`);
        if (list[idx]) {
          list[idx].checked = true;
          previewEffects();
        }
      }
    });

    if (S.phase !== 'ended' && (S.history && S.history.length > 0 || S.phase !== 'startup')) {
      elIntro.style.display = 'none';
      elFinal.style.display = 'none';
      elGame.style.display = 'block';
      renderDecisionsForPhase();
      updateStatus();
    }

    (function smokeTests() {
      try {
        console.groupCollapsed('Esports Sim v2.3 Smoke Tests');
        console.assert(typeof winProbability() === 'number','winProbability returns number');
        const p = winProbability();
        console.assert(p >= 0.05 && p <= 0.95,'winProbability clamped [0.05,0.95]');
        console.assert(!!document.getElementById('btnPDF'),'btnPDF exists');
        console.assert(!!document.getElementById('btnContinueExtended'),'btnContinueExtended exists');
        console.groupEnd();
      } catch(err){
        console.warn('Smoke tests failed',err);
      }
    })();
  });
  </script>
</body>
</html>
